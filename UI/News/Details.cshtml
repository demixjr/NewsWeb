@page "{id:int}"
@model NewsPortal.Pages.News.DetailsModel

@{
    ViewData["Title"] = Model.News?.Title ?? "News Details";
}

@section Styles {
    <style>
        .news-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4rem 0;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

            .news-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.3);
                z-index: 1;
            }

        .news-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .news-meta {
            position: relative;
            z-index: 2;
        }

        .news-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #333;
        }

            .news-content img {
                max-width: 100%;
                height: auto;
                border-radius: 10px;
                margin: 1.5rem 0;
            }

        .news-actions {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 2rem;
        }

        .related-news-card {
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            height: 100%;
        }

            .related-news-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                border-color: #0d6efd;
            }

        .comment-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .comment-item {
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
        }

            .comment-item:last-child {
                border-bottom: none;
            }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .btn-favorite {
            transition: all 0.3s ease;
        }

            .btn-favorite.active {
                color: #dc3545;
                transform: scale(1.1);
            }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 0.3s ease;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .tag {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }
    </style>
}

<!-- News Header -->
<div class="news-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <div class="news-meta mb-4">
                    <span class="badge bg-light text-primary me-2">
                        @Model.News.Category?.Name
                    </span>
                    <span class="me-3">
                        <i class="far fa-clock me-1"></i>
                        @Model.News.Date.ToString("MMMM dd, yyyy")
                    </span>
                    <span>
                        <i class="far fa-eye me-1"></i>
                        <span id="viewsCount">@Model.News.Views</span> views
                    </span>
                </div>

                <h1 class="news-title">@Model.News.Title</h1>

                <div class="author-info">
                    <i class="fas fa-user-edit me-2"></i>
                    By <strong>@Model.News.Author?.Username</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- News Image/Placeholder -->
            <div class="card mb-4">
                <div class="card-body text-center p-5">
                    <div class="mb-4">
                        <i class="fas fa-newspaper fa-5x text-primary"></i>
                    </div>
                    <p class="text-muted">
                        <i class="fas fa-image me-1"></i>
                        Featured image placeholder
                    </p>
                </div>
            </div>

            <!-- News Content -->
            <div class="card mb-4">
                <div class="card-body news-content">
                    @Html.Raw(Model.News.Description?.Replace("\n", "<br>"))

                    <!-- Tags -->
                    <div class="tag-list mt-4">
                        <span class="tag">#news</span>
                        <span class="tag">#@Model.News.Category?.Name?.ToLower()</span>
                        <span class="tag">#@DateTime.Now.Year</span>
                        <span class="tag">#trending</span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="news-actions">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="shareNews()">
                            <i class="fas fa-share-alt me-1"></i>Share
                        </button>
                        <button class="btn btn-outline-danger btn-favorite"
                                onclick="toggleFavorite(@Model.News.Id, this)" id="favoriteBtn">
                            <i class="far fa-heart me-1"></i>
                            <span class="favorite-count">12</span>
                        </button>
                    </div>

                    @if (Model.CanEdit)
                    {
                        <div>
                            <a href="/News/Edit/@Model.News.Id" class="btn btn-primary me-2">
                                <i class="fas fa-edit me-1"></i>Edit
                            </a>
                            <button class="btn btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteModal">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </div>
                    }
                </div>

                <!-- Social Share -->
                <div class="mt-3" id="shareButtons" style="display: none;">
                    <button class="btn btn-sm btn-outline-primary me-1">
                        <i class="fab fa-facebook"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info me-1">
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger me-1">
                        <i class="fab fa-pinterest"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyLink()">
                        <i class="fas fa-link"></i> Copy Link
                    </button>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="comment-section">
                <h4 class="mb-4">
                    <i class="fas fa-comments me-2"></i>
                    Comments <span id="commentCount" class="badge bg-primary">@Model.Comments.Count</span>
                </h4>

                <!-- Add Comment Form -->
                @if (User.Identity.IsAuthenticated)
                {
                    <form id="commentForm" class="mb-4">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <textarea class="form-control" id="commentContent"
                                  rows="3" placeholder="Add a comment..."
                                  maxlength="500"></textarea>
                            <small class="text-muted float-end">
                                <span id="charCount">0</span>/500
                            </small>
                        </div>
                        <button type="button" class="btn btn-primary"
                                onclick="submitComment(@Model.News.Id)">
                            <i class="fas fa-paper-plane me-1"></i>Post Comment
                        </button>
                    </form>
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Please <a href="/Account/Login">login</a> to post a comment.
                    </div>
                }

                <!-- Comments List -->
                <div id="commentsList">
                    @if (Model.Comments.Any())
                    {
                        foreach (var comment in Model.Comments)
                        {
                            <div class="comment-item">
                                <div class="d-flex">
                                    <div class="comment-avatar me-3">
                                        @comment.UserName.Substring(0, 1).ToUpper()
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">@comment.UserName</h6>
                                                <small class="text-muted">
                                                    @comment.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                                                </small>
                                            </div>
                                            @if (User.Identity.IsAuthenticated &&
                                                                                (User.Identity.Name == comment.UserName || User.IsInRole("Admin")))
                                            {
                                                <button class="btn btn-sm btn-outline-danger"
                                                        onclick="deleteComment(@comment.Id)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            }
                                        </div>
                                        <p class="mb-0 mt-2">@comment.Content</p>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No comments yet. Be the first to comment!</p>
                        </div>
                    }
                </div>

                <!-- Load More Comments -->
                @if (Model.Comments.Count >= 5)
                {
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-primary btn-sm" id="loadMoreComments">
                            <i class="fas fa-arrow-down me-1"></i>Load More Comments
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Author Info -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>About the Author
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div class="author-avatar mx-auto mb-2"
                             style="width: 80px; height: 80px; background-color: #667eea;
                                    color: white; border-radius: 50%; display: flex;
                                    align-items: center; justify-content: center; font-size: 2rem;">
                            @Model.News.Author?.Username?.Substring(0, 1).ToUpper()
                        </div>
                        <h5>@Model.News.Author?.Username</h5>
                        <span class="badge bg-warning">@Model.News.Author?.Role</span>
                    </div>

                    @if (User.Identity.IsAuthenticated && Model.IsAuthor)
                    {
                        <div class="d-grid gap-2">
                            <a href="/News/MyNews" class="btn btn-outline-primary">
                                <i class="fas fa-newspaper me-1"></i>My News
                            </a>
                            <a href="/News/Create" class="btn btn-outline-success">
                                <i class="fas fa-plus me-1"></i>Create New
                            </a>
                        </div>
                    }
                </div>
            </div>

            <!-- Related News -->
            @if (Model.RelatedNews.Any())
            {
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-link me-2"></i>Related News
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            @foreach (var related in Model.RelatedNews)
                            {
                                <a href="/News/Details/@related.Id"
                                   class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">@related.Title</h6>
                                        <small>@related.Date.ToString("MMM dd")</small>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-eye me-1"></i>@related.Views views
                                    </small>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Share Stats -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Engagement Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="display-6 text-primary">
                                <i class="fas fa-eye"></i>
                            </div>
                            <small class="text-muted">Views</small>
                            <div class="fw-bold">@Model.News.Views</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="display-6 text-success">
                                <i class="fas fa-share-alt"></i>
                            </div>
                            <small class="text-muted">Shares</small>
                            <div class="fw-bold">45</div>
                        </div>
                    </div>
                    <div class="progress mb-2" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: 70%"></div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-chart-bar me-1"></i>
                        70% engagement rate
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete News
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-trash fa-3x text-danger"></i>
                </div>
                <p class="text-center">
                    Are you sure you want to delete this news article?
                    <br>
                    <strong>"@Model.News.Title"</strong>
                </p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    This action cannot be undone. All comments and statistics will be lost.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="/News/Delete/@Model.News.Id" class="btn btn-danger">
                    <i class="fas fa-trash me-1"></i>Delete Permanently
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Increment views on page load
        $(document).ready(function() {
            incrementViews(@Model.News.Id);

            // Initialize character count for comment
            $('#commentContent').on('input', function() {
                const length = $(this).val().length;
                $('#charCount').text(length);
            });
        });

        // Share news functionality
        function shareNews() {
            $('#shareButtons').slideToggle();
        }

        function copyLink() {
            const link = window.location.href;
            navigator.clipboard.writeText(link).then(function() {
                alert('Link copied to clipboard!');
            });
        }

        // Submit comment via AJAX
        function submitComment(newsId) {
            const content = $('#commentContent').val().trim();

            if (!content) {
                alert('Please enter a comment');
                return;
            }

            $.ajax({
                url: `/News/Details/${newsId}?handler=AddComment`,
                type: 'POST',
                data: {
                    content: content,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // Add new comment to list
                        const commentHtml = `
                            <div class="comment-item fade-in">
                                <div class="d-flex">
                                    <div class="comment-avatar me-3">
                                        ${response.userName.substring(0, 1).toUpperCase()}
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">${response.userName}</h6>
                                                <small class="text-muted">Just now</small>
                                            </div>
                                            <button class="btn btn-sm btn-outline-danger"
                                                    onclick="deleteComment(${response.comment.id})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <p class="mb-0 mt-2">${response.content}</p>
                                    </div>
                                </div>
                            </div>
                        `;

                        $('#commentsList').prepend(commentHtml);
                        $('#commentContent').val('');
                        $('#charCount').text('0');

                        // Update comment count
                        const count = parseInt($('#commentCount').text()) + 1;
                        $('#commentCount').text(count);

                        // Show success message
                        showToast('Comment posted successfully!', 'success');
                    }
                },
                error: function() {
                    alert('Failed to post comment. Please try again.');
                }
            });
        }

        // Delete comment
        function deleteComment(commentId) {
            if (confirm('Are you sure you want to delete this comment?')) {
                $.ajax({
                    url: `/News/Details/@Model.News.Id?handler=DeleteComment&commentId=${commentId}`,
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            $(`[onclick="deleteComment(${commentId})"]`).closest('.comment-item').fadeOut(300, function() {
                                $(this).remove();
                                // Update comment count
                                const count = parseInt($('#commentCount').text()) - 1;
                                $('#commentCount').text(count);
                            });
                        }
                    }
                });
            }
        }

        // Load more comments
        $('#loadMoreComments').click(function() {
            const $btn = $(this);
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Loading...');

            // Load more comments via AJAX
            // Implementation depends on your pagination logic
        });

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = $(`
                <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                    <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                </div>
            `);

            $('body').append(toast);
            $('.toast').toast('show');

            setTimeout(() => {
                $('.toast').toast('hide').remove();
            }, 3000);
        }
    </script>
}